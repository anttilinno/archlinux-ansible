---
- name: Partitioning block
  block:
    - name: Wipe disk signatures when force repartition
      ansible.builtin.command: wipefs -af {{ arch_install_disk }}
      when: arch_install_force_repartition | bool

    - name: Detect current partition table type
      ansible.builtin.command: lsblk -no PTTYPE {{ arch_install_disk }}
      register: arch_install_pttype
      changed_when: false
      failed_when: arch_install_pttype.rc not in [0, 32]
      check_mode: false

    # BIOS: MBR with swap + root
    - name: Create MBR partition table (BIOS)
      ansible.builtin.command: parted -s {{ arch_install_disk }} mklabel msdos
      when:
        - arch_install_boot_mode == 'bios'
        - arch_install_force_repartition | bool or not arch_install_already_installed.stat.exists
        - arch_install_pttype.stdout | trim != 'dos'

    - name: Create swap partition (BIOS)
      community.general.parted:
        device: "{{ arch_install_disk }}"
        number: 1
        part_type: primary
        part_start: 1MiB
        part_end: "{{ arch_install_swap_size }}"
        fs_type: linux-swap
        state: present
      when:
        - arch_install_boot_mode == 'bios'
        - arch_install_force_repartition | bool or not arch_install_already_installed.stat.exists

    - name: Create root partition (BIOS)
      community.general.parted:
        device: "{{ arch_install_disk }}"
        number: 2
        part_type: primary
        part_start: "{{ arch_install_swap_size }}"
        part_end: 100%
        fs_type: ext4
        flags: [boot]
        state: present
      when:
        - arch_install_boot_mode == 'bios'
        - arch_install_force_repartition | bool or not arch_install_already_installed.stat.exists

    # UEFI: GPT with EFI + swap + root (using raw parted - module has GPT flag bugs)
    - name: Create UEFI partitions
      ansible.builtin.shell: |
        parted -s {{ arch_install_disk }} mklabel gpt
        parted -s {{ arch_install_disk }} mkpart primary fat32 1MiB {{ arch_install_efi_size }}
        parted -s {{ arch_install_disk }} set 1 esp on
        parted -s {{ arch_install_disk }} mkpart primary linux-swap {{ arch_install_efi_size }} {{ arch_install_efi_size | regex_replace('([0-9]+).*', '\\1') | int + arch_install_swap_size | regex_replace('([0-9]+).*', '\\1') | int }}MiB
        parted -s {{ arch_install_disk }} mkpart primary ext4 {{ arch_install_efi_size | regex_replace('([0-9]+).*', '\\1') | int + arch_install_swap_size | regex_replace('([0-9]+).*', '\\1') | int }}MiB 100%
      when:
        - arch_install_boot_mode == 'uefi'
        - arch_install_force_repartition | bool or not arch_install_already_installed.stat.exists

    # Filesystems - BIOS
    - name: Create swap filesystem (BIOS)
      community.general.filesystem:
        fstype: swap
        dev: "{{ arch_install_part_prefix }}1"
        force: "{{ arch_install_force_repartition | bool }}"
      when:
        - arch_install_boot_mode == 'bios'
        - arch_install_force_repartition | bool or not arch_install_already_installed.stat.exists

    - name: Create ext4 root filesystem (BIOS)
      community.general.filesystem:
        fstype: ext4
        dev: "{{ arch_install_part_prefix }}2"
        opts: "-L {{ arch_install_root_fs_label }}"
        force: "{{ arch_install_force_repartition | bool }}"
      when:
        - arch_install_boot_mode == 'bios'
        - arch_install_force_repartition | bool or not arch_install_already_installed.stat.exists

    # Filesystems - UEFI
    - name: Create FAT32 EFI filesystem (UEFI)
      community.general.filesystem:
        fstype: vfat
        dev: "{{ arch_install_part_prefix }}1"
        opts: "-F 32"
        force: "{{ arch_install_force_repartition | bool }}"
      when:
        - arch_install_boot_mode == 'uefi'
        - arch_install_force_repartition | bool or not arch_install_already_installed.stat.exists

    - name: Create swap filesystem (UEFI)
      community.general.filesystem:
        fstype: swap
        dev: "{{ arch_install_part_prefix }}2"
        force: "{{ arch_install_force_repartition | bool }}"
      when:
        - arch_install_boot_mode == 'uefi'
        - arch_install_force_repartition | bool or not arch_install_already_installed.stat.exists

    - name: Create ext4 root filesystem (UEFI)
      community.general.filesystem:
        fstype: ext4
        dev: "{{ arch_install_part_prefix }}3"
        opts: "-L {{ arch_install_root_fs_label }}"
        force: "{{ arch_install_force_repartition | bool }}"
      when:
        - arch_install_boot_mode == 'uefi'
        - arch_install_force_repartition | bool or not arch_install_already_installed.stat.exists

  rescue:
    - name: Partitioning failed
      ansible.builtin.fail:
        msg: "Partitioning failed. Check disk {{ arch_install_disk }} status and permissions."

  tags:
    - partitioning
